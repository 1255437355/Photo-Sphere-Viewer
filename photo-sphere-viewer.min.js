/*!
 * Photo Sphere Viewer v3.0.0
 * http://jeremyheleine.com/#photo-sphere-viewer
 * Copyright (c) 2014,2015 Jérémy Heleine
 * Licensed under MIT (http://opensource.org/licenses/MIT)
 */
!function(a,b){"function"==typeof define&&define.amd?define(["three"],b):a.PhotoSphereViewer=b(a.THREE)}(this,function(a){"use strict";var b=function(a){if(void 0===a||void 0===a.panorama||void 0===a.container)throw"PhotoSphereViewer: no value given for panorama or container";this.config=h.deepmerge(b.DEFAULTS,a),this.config.min_fov=h.stayBetween(this.config.min_fov,1,179),this.config.max_fov=h.stayBetween(this.config.max_fov,1,179),this.config.theta_offset=Math.PI/this.config.theta_offset,this.container=this.config.container,this.navbar=null,this.root=null,this.canvas_container=null,this.renderer=null,this.scene=null,this.camera=null,this.prop={size:null,phi:0,theta:0,zoom_lvl:0,mousedown:!1,mouse_x:0,mouse_y:0,autorotate_timeout:null,anim_timeout:null},this.actions={},this.setAnimSpeed(this.config.anim_speed),null!==this.config.size&&this.setViewerSize(this.config.size),this.config.autoload&&this.load()};b.DEFAULTS={panorama:null,container:null,autoload:!0,usexmpdata:!0,min_fov:30,max_fov:90,long_offset:Math.PI/360,lat_offset:Math.PI/180,time_anim:2e3,theta_offset:1440,anim_speed:"2rpm",navbar:!1,navbar_style:{},loading_img:null,size:null,fps:60},b.prototype.load=function(){if(this.config.loading_img){var a=document.createElement("img");a.setAttribute("src",this.config.loading_img),a.setAttribute("alt","Loading..."),this.container.appendChild(a)}else this.container.textContent="Loading...";return this.root=document.createElement("div"),this.root.style.width="100%",this.root.style.height="100%",this.root.style.position="relative",h.isCanvasSupported()?(this.canvas_container=document.createElement("div"),this.canvas_container.style.position="absolute",this.canvas_container.style.zIndex=0,this.root.appendChild(this.canvas_container),this.config.navbar&&(this.navbar=new c(this,this.config.navbar_style),this.root.appendChild(this.navbar.getBar())),h.addEvent(window,"resize",this._onResize.bind(this)),h.addEvent(this.canvas_container,"mousedown",this._onMouseDown.bind(this)),h.addEvent(this.canvas_container,"touchstart",this._onTouchStart.bind(this)),h.addEvent(document,"mouseup",this._onMouseUp.bind(this)),h.addEvent(document,"touchend",this._onMouseUp.bind(this)),h.addEvent(document,"mousemove",this._onMouseMove.bind(this)),h.addEvent(document,"touchmove",this._onTouchMove.bind(this)),h.addEvent(this.canvas_container,"mousewheel",this._onMouseWheel.bind(this)),h.addEvent(this.canvas_container,"DOMMouseScroll",this._onMouseWheel.bind(this)),h.addEvent(document,"fullscreenchange",this._fullscreenToggled.bind(this)),h.addEvent(document,"mozfullscreenchange",this._fullscreenToggled.bind(this)),h.addEvent(document,"webkitfullscreenchange",this._fullscreenToggled.bind(this)),h.addEvent(document,"MSFullscreenChange",this._fullscreenToggled.bind(this)),this.container.innerHTML="",this.container.appendChild(this.root),this.prop.size={width:0,height:0,ratio:0},void(this.config.usexmpdata?this.loadXMP():this.createBuffer(!1))):void(this.container.textContent="Canvas is not supported, update your browser!")},b.prototype.loadXMP=function(){var a=null,b=this;if(window.XMLHttpRequest)a=new XMLHttpRequest;else{if(!window.ActiveXObject)return void(this.container.textContent="XHR is not supported, update your browser!");try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(c){a=new ActiveXObject("Microsoft.XMLHTTP")}}a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var c=a.responseText,d=c.indexOf("<x:xmpmeta"),e=c.indexOf("</x:xmpmeta>"),f=c.substring(d,e);if(-1==d||-1==e||-1==f.indexOf("GPano:"))return void b.createBuffer(!1);var g={full_width:parseInt(h.getAttribute(f,"FullPanoWidthPixels")),full_height:parseInt(h.getAttribute(f,"FullPanoHeightPixels")),cropped_width:parseInt(h.getAttribute(f,"CroppedAreaImageWidthPixels")),cropped_height:parseInt(h.getAttribute(f,"CroppedAreaImageHeightPixels")),cropped_x:parseInt(h.getAttribute(f,"CroppedAreaLeftPixels")),cropped_y:parseInt(h.getAttribute(f,"CroppedAreaTopPixels"))};b.createBuffer(g)}},a.open("GET",this.config.panorama,!0),a.send(null)},b.prototype.createBuffer=function(a){var b=new Image,c=this;b.onload=function(){a||(a={full_width:b.width,full_height:b.height,cropped_width:b.width,cropped_height:b.height,cropped_x:0,cropped_y:0});var d=2048;h.isWebGLSupported()&&(d=h.getMaxTextureWidth());var e=Math.min(a.full_width,d),f=e/a.full_width;a.full_width=e,a.cropped_width*=f,a.cropped_x*=f,b.width=a.cropped_width,a.full_height*=f,a.cropped_height*=f,a.cropped_y*=f,b.height=a.cropped_height;var g=document.createElement("canvas");g.width=a.full_width,g.height=a.full_height;var i=g.getContext("2d");i.drawImage(b,a.cropped_x,a.cropped_y,a.cropped_width,a.cropped_height),c.loadTexture(g.toDataURL("image/jpeg"))},this.config.panorama.match(/^data:image\/[a-z]+;base64/)||b.setAttribute("crossOrigin","anonymous"),b.src=this.config.panorama},b.prototype.loadTexture=function(b){var c=new a.Texture,d=new a.ImageLoader,e=this,f=function(a){c.needsUpdate=!0,c.image=a,e.createScene(c)};d.load(b,f)},b.prototype.createScene=function(b){this._onResize(),this.renderer=h.isWebGLSupported()?new a.WebGLRenderer:new a.CanvasRenderer,this.renderer.setSize(this.prop.size.width,this.prop.size.height),this.scene=new a.Scene,this.camera=new a.PerspectiveCamera(this.config.max_fov,this.prop.size.ratio,1,300),this.camera.position.set(0,0,0),this.scene.add(this.camera);var c=new a.SphereGeometry(200,32,32),d=new a.MeshBasicMaterial({map:b,overdraw:!0}),e=new a.Mesh(c,d);e.scale.x=-1,this.scene.add(e);var f=this.renderer.domElement;f.style.display="block",this.canvas_container.appendChild(f),this.render(),this.config.time_anim!==!1&&(this.prop.anim_timeout=setTimeout(this.startAutorotate.bind(this),this.config.time_anim))},b.prototype.render=function(){var b=new a.Vector3;b.setX(Math.cos(this.prop.phi)*Math.sin(this.prop.theta)),b.setY(Math.sin(this.prop.phi)),b.setZ(Math.cos(this.prop.phi)*Math.cos(this.prop.theta)),this.camera.lookAt(b),this.renderer.render(this.scene,this.camera)},b.prototype._autorotate=function(){this.prop.phi-=this.prop.phi/200,this.prop.theta+=this.config.theta_offset,this.prop.theta-=2*Math.floor(this.prop.theta/(2*Math.PI))*Math.PI,this.render(),this.prop.autorotate_timeout=setTimeout(this._autorotate.bind(this),1e3/this.config.fps)},b.prototype.startAutorotate=function(){this._autorotate(),this.triggerAction("autorotate",!0)},b.prototype.stopAutorotate=function(){clearTimeout(this.prop.anim_timeout),this.prop.anim_timeout=null,clearTimeout(this.prop.autorotate_timeout),this.prop.autorotate_timeout=null,this.triggerAction("autorotate",!1)},b.prototype.toggleAutorotate=function(){clearTimeout(this.prop.anim_timeout),this.prop.autorotate_timeout?this.stopAutorotate():this.startAutorotate()},b.prototype._onResize=function(){(this.container.clientWidth!=this.prop.size.width||this.container.clientHeight!=this.prop.size.height)&&this.resize({width:this.container.clientWidth,height:this.container.clientHeight})},b.prototype.resize=function(a){this.prop.size.width=void 0!==a.width?parseInt(a.width):this.prop.size.width,this.prop.size.height=void 0!==a.height?parseInt(a.height):this.prop.size.height,this.prop.size.ratio=this.prop.size.width/this.prop.size.height,this.camera&&(this.camera.aspect=this.prop.size.ratio,this.camera.updateProjectionMatrix()),this.renderer&&(this.renderer.setSize(this.prop.size.width,this.prop.size.height),this.render())},b.prototype._onMouseDown=function(a){this._startMove(parseInt(a.clientX),parseInt(a.clientY))},b.prototype._onTouchStart=function(a){var b=a.changedTouches[0];b.target.parentNode==this.canvas_container&&this._startMove(parseInt(b.clientX),parseInt(b.clientY))},b.prototype._startMove=function(a,b){this.prop.mouse_x=a,this.prop.mouse_y=b,this.stopAutorotate(),this.prop.mousedown=!0},b.prototype._onMouseUp=function(a){this.prop.mousedown=!1},b.prototype._onMouseMove=function(a){a.preventDefault(),this._move(parseInt(a.clientX),parseInt(a.clientY))},b.prototype._onTouchMove=function(a){var b=a.changedTouches[0];b.target.parentNode==this.canvas_container&&(a.preventDefault(),this._move(parseInt(b.clientX),parseInt(b.clientY)))},b.prototype._move=function(a,b){this.prop.mousedown&&(this.rotate(this.prop.theta+(a-this.prop.mouse_x)*this.config.long_offset,this.prop.phi+(b-this.prop.mouse_y)*this.config.lat_offset),this.prop.mouse_x=a,this.prop.mouse_y=b)},b.prototype.rotate=function(a,b){this.prop.theta=a,this.prop.phi=h.stayBetween(b,-Math.PI/2,Math.PI/2),this.render()},b.prototype._onMouseWheel=function(a){a.preventDefault(),a.stopPropagation();var b=a.detail?-a.detail:a.wheelDelta;if(0!==b){var c=parseInt(b/Math.abs(b));this.zoom(this.prop.zoom_lvl+c)}},b.prototype.zoom=function(a){this.prop.zoom_lvl=h.stayBetween(parseInt(Math.round(a)),0,100),this.camera.fov=this.config.max_fov+this.prop.zoom_lvl/100*(this.config.min_fov-this.config.max_fov),this.camera.updateProjectionMatrix(),this.render(),this.triggerAction("zoom-updated",this.prop.zoom_lvl)},b.prototype.zoomIn=function(){this.prop.zoom_lvl<100&&this.zoom(this.prop.zoom_lvl+1)},b.prototype.zoomOut=function(){this.prop.zoom_lvl>0&&this.zoom(this.prop.zoom_lvl-1)},b.prototype._fullscreenToggled=function(){this.triggerAction("fullscreen-mode",h.isFullscreenEnabled())},b.prototype.toggleFullscreen=function(){h.isFullscreenEnabled()?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():this.container.requestFullscreen?this.container.requestFullscreen():this.container.mozRequestFullScreen?this.container.mozRequestFullScreen():this.container.webkitRequestFullscreen?this.container.webkitRequestFullscreen():this.container.msRequestFullscreen&&this.container.msRequestFullscreen()},b.prototype.setAnimSpeed=function(a){a=a.toString().trim();var b=parseFloat(a.replace(/^(-?[0-9]+(?:\.[0-9]*)?).*$/,"$1")),c=a.replace(/^-?[0-9]+(?:\.[0-9]*)?(.*)$/,"$1").trim();c.match(/(pm|per minute)$/)&&(b/=60);var d=0;switch(c){case"rpm":case"rev per minute":case"revolutions per minute":case"rps":case"rev per second":case"revolutions per second":d=2*b*Math.PI;break;case"dpm":case"deg per minute":case"degrees per minute":case"dps":case"deg per second":case"degrees per second":d=b*Math.PI/180;break;case"rad per minute":case"radians per minute":case"rad per second":case"radians per second":d=b;break;default:m_anim=!1}this.config.theta_offset=d/this.config.fps},b.prototype.setViewerSize=function(a){for(var b in a)if("width"==b||"height"==b){var c=a[b].toString().trim(),d=parseFloat(c.replace(/^([0-9]+(?:\.[0-9]*)?).*$/,"$1")),e=c.replace(/^[0-9]+(?:\.[0-9]*)?(.*)$/,"$1").trim();"%"!=e&&(e="px"),this.container.style[b]=d+e}},b.prototype.addAction=function(a,b){a in this.actions||(this.actions[a]=[]),this.actions[a].push(b)},b.prototype.triggerAction=function(a,b){if(a in this.actions&&this.actions[a].length>0)for(var c=0,d=this.actions[a].length;d>c;++c)this.actions[a][c](b)};var c=function(a,b){this.style=h.deepmerge(c.DEFAULTS,b),this.psv=a,this.container=null,this.arrows=null,this.autorotate=null,this.zoom=null,this.fullscreen=null,this.create()};c.DEFAULTS={backgroundColor:"rgba(61, 61, 61, 0.5)",buttonsColor:"rgba(255, 255, 255, 0.7)",buttonsBackgroundColor:"transparent",activeButtonsBackgroundColor:"rgba(255, 255, 255, 0.1)",buttonsHeight:20,autorotateThickness:1,zoomRangeWidth:50,zoomRangeThickness:1,zoomRangeDisk:7,fullscreenRatio:4/3,fullscreenThickness:2},c.prototype.create=function(){this.container=document.createElement("div"),this.container.style.backgroundColor=this.style.backgroundColor,this.container.style.position="absolute",this.container.style.zIndex=10,this.container.style.bottom=0,this.container.style.width="100%",this.autorotate=new e(this.psv,this.style),this.container.appendChild(this.autorotate.getButton()),this.zoom=new g(this.psv,this.style),this.container.appendChild(this.zoom.getButton()),this.fullscreen=new f(this.psv,this.style),this.container.appendChild(this.fullscreen.getButton())},c.prototype.getBar=function(){return this.container};var d=function(a,b){this.style=b,this.psv=a,this.button=null};d.prototype.create=function(){throw"Not implemented"},d.prototype.getButton=function(){return this.button},d.prototype.toggleActive=function(a){this.button.style.backgroundColor=a?this.style.activeButtonsBackgroundColor:this.style.buttonsBackgroundColor};var e=function(a,b){d.call(this,a,b),this.create()};e.prototype=Object.create(d.prototype),e.prototype.constructor=e,e.prototype.create=function(){var a=this.style.buttonsHeight-2*this.style.autorotateThickness,b=a/10;this.button=document.createElement("div"),this.button.style.cssFloat="left",this.button.style.padding="10px",this.button.style.width=this.style.buttonsHeight+"px",this.button.style.height=this.style.buttonsHeight+"px",this.button.style.backgroundColor=this.style.buttonsBackgroundColor,this.button.style.position="relative",this.button.style.cursor="pointer",h.addEvent(this.button,"click",this.psv.toggleAutorotate.bind(this.psv));var c=document.createElement("div");c.style.width=a+"px",c.style.height=a+"px",c.style.borderRadius="50%",c.style.border=this.style.autorotateThickness+"px solid "+this.style.buttonsColor,this.button.appendChild(c);var d=document.createElement("div");d.style.width=a+"px",d.style.height=b+"px",d.style.borderRadius="50%",d.style.border=this.style.autorotateThickness+"px solid "+this.style.buttonsColor,d.style.position="absolute",d.style.top="50%",d.style.marginTop=-(b/2+this.style.autorotateThickness)+"px",this.button.appendChild(d),this.psv.addAction("autorotate",this.toggleActive.bind(this))};var f=function(a,b){d.call(this,a,b),this.create()};f.prototype=Object.create(d.prototype),f.prototype.constructor=f,f.prototype.create=function(){var a=this.style.buttonsHeight*this.style.fullscreenRatio,b=.3*this.style.buttonsHeight,c=(this.style.buttonsHeight-b)/2,d=.3*a,e=(a-d)/2-this.style.fullscreenThickness,f=this.style.buttonsHeight-2*this.style.fullscreenThickness;this.button=document.createElement("div"),this.button.style.cssFloat="right",this.button.style.padding="10px",this.button.style.width=a,this.button.style.height=this.style.buttonsHeight,this.button.style.backgroundColor=this.style.buttonsBackgroundColor,this.button.style.cursor="pointer",h.addEvent(this.button,"click",this.psv.toggleFullscreen.bind(this.psv));var g=document.createElement("div");g.style.cssFloat="left",g.style.width=this.style.fullscreenThickness+"px",g.style.height=b+"px",g.style.borderStyle="solid",g.style.borderColor=this.style.buttonsColor+" transparent",g.style.borderWidth=c+"px 0",this.button.appendChild(g);var i=document.createElement("div");i.style.cssFloat="left",i.style.width=e+"px",i.style.height=f+"px",i.style.borderStyle="solid",i.style.borderColor=this.style.buttonsColor+" transparent",i.style.borderWidth=this.style.fullscreenThickness+"px 0",this.button.appendChild(i);var j=document.createElement("div");j.style.cssFloat="left",j.style.marginLeft=d+"px",j.style.width=e+"px",j.style.height=f+"px",j.style.borderStyle="solid",j.style.borderColor=this.style.buttonsColor+" transparent",j.style.borderWidth=this.style.fullscreenThickness+"px 0",this.button.appendChild(j);var k=document.createElement("div");k.style.cssFloat="left",k.style.width=this.style.fullscreenThickness+"px",k.style.height=b+"px",k.style.borderStyle="solid",k.style.borderColor=this.style.buttonsColor+" transparent",k.style.borderWidth=c+"px 0",this.button.appendChild(k);var l=document.createElement("div");l.style.clear="left",this.button.appendChild(l),this.psv.addAction("fullscreen-mode",this.toggleActive.bind(this))};var g=function(a,b){d.call(this,a,b),this.zoom_range=null,this.zoom_value=null,this.mousedown=!1,this.create()};g.prototype=Object.create(d.prototype),g.prototype.constructor=g,g.prototype.create=function(){this.button=document.createElement("div"),this.button.style.cssFloat="left";var a=document.createElement("div");a.style.cssFloat="left",a.style.padding="10px",a.style.height=this.style.buttonsHeight+"px",a.style.backgroundColor=this.style.buttonsBackgroundColor,a.style.lineHeight=this.style.buttonsHeight+"px",a.style.color=this.style.buttonsColor,a.style.cursor="pointer",a.textContent="-",h.addEvent(a,"click",this.psv.zoomOut.bind(this.psv)),this.button.appendChild(a);var b=document.createElement("div");b.style.cssFloat="left",b.style.padding=10+(this.style.buttonsHeight-this.style.zoomRangeThickness)/2+"px 5px",b.style.backgroundColor=this.style.buttonsBackgroundColor,this.button.appendChild(b),this.zoom_range=document.createElement("div"),this.zoom_range.style.width=this.style.zoomRangeWidth+"px",this.zoom_range.style.height=this.style.zoomRangeThickness+"px",this.zoom_range.style.backgroundColor=this.style.buttonsColor,this.zoom_range.style.position="relative",this.zoom_range.style.cursor="pointer",b.appendChild(this.zoom_range),this.zoom_value=document.createElement("div"),this.zoom_value.style.position="absolute",this.zoom_value.style.top=(this.style.zoomRangeThickness-this.style.zoomRangeDisk)/2+"px",this.zoom_value.style.left=-(this.style.zoomRangeDisk/2)+"px",this.zoom_value.style.width=this.style.zoomRangeDisk+"px",this.zoom_value.style.height=this.style.zoomRangeDisk+"px",this.zoom_value.style.borderRadius="50%",this.zoom_value.style.backgroundColor=this.style.buttonsColor,this.psv.addAction("zoom-updated",this._moveZoomValue.bind(this)),h.addEvent(this.zoom_range,"mousedown",this._initZoomChangeWithMouse.bind(this)),h.addEvent(this.zoom_range,"touchstart",this._initZoomChangeByTouch.bind(this)),h.addEvent(document,"mousemove",this._changeZoomWithMouse.bind(this)),h.addEvent(document,"touchmove",this._changeZoomByTouch.bind(this)),h.addEvent(document,"mouseup",this._stopZoomChange.bind(this)),h.addEvent(document,"touchend",this._stopZoomChange.bind(this)),this.zoom_range.appendChild(this.zoom_value);var c=document.createElement("div");c.style.cssFloat="left",c.style.padding="10px",c.style.height=this.style.buttonsHeight+"px",c.style.backgroundColor=this.style.buttonsBackgroundColor,c.style.lineHeight=this.style.buttonsHeight+"px",c.style.color=this.style.buttonsColor,c.style.cursor="pointer",c.textContent="+",h.addEvent(c,"click",this.psv.zoomIn.bind(this.psv)),this.button.appendChild(c)},g.prototype._moveZoomValue=function(a){this.zoom_value.style.left=a/100*this.style.zoomRangeWidth-this.style.zoomRangeDisk/2+"px"},g.prototype._initZoomChangeWithMouse=function(a){this._initZoomChange(parseInt(a.clientX))},g.prototype._initZoomChangeByTouch=function(a){var b=a.changedTouches[0];(b.target==this.zoom_range||b.target==this.zoom_value)&&this._initZoomChange(parseInt(b.clientX))},g.prototype._initZoomChange=function(a){this.mousedown=!0,this._changeZoom(a)},g.prototype._stopZoomChange=function(a){this.mousedown=!1},g.prototype._changeZoomWithMouse=function(a){a.preventDefault(),this._changeZoom(parseInt(a.clientX))},g.prototype._changeZoomByTouch=function(a){var b=a.changedTouches[0];(b.target==this.zoom_range||b.target==this.zoom_value)&&(a.preventDefault(),this._changeZoom(parseInt(b.clientX)))},g.prototype._changeZoom=function(a){if(this.mousedown){var b=a-this.zoom_range.getBoundingClientRect().left,c=b/this.style.zoomRangeWidth*100;this.psv.zoom(c)}};var h={};return h.isCanvasSupported=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))},h.isWebGLSupported=function(){var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl"))},h.getMaxTextureWidth=function(){var a=document.createElement("canvas"),b=a.getContext("webgl");return b.getParameter(b.MAX_TEXTURE_SIZE)},h.addEvent=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},h.stayBetween=function(a,b,c){return Math.max(b,Math.min(c,a))},h.getAttribute=function(a,b){var c=a.indexOf("GPano:"+b)+b.length+8,d=a.indexOf('"',c);return a.substring(c,d)},h.isFullscreenEnabled=function(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)},h.deepmerge=function(a,b){var c=Array.isArray(b),d=c&&[]||{};return c?(a=a||[],d=d.concat(a),b.forEach(function(b,c){"undefined"==typeof d[c]?d[c]=b:"object"==typeof b?d[c]=h.deepmerge(a[c],b):-1===a.indexOf(b)&&d.push(b)})):(a&&"object"==typeof a&&Object.keys(a).forEach(function(b){d[b]=a[b]}),Object.keys(b).forEach(function(c){d[c]="object"==typeof b[c]&&b[c]&&a[c]?h.deepmerge(a[c],b[c]):b[c]})),d},b});